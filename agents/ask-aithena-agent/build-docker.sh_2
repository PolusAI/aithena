#!/bin/bash

# Derive the tool name from the folder name
script_dir=$(dirname "$(realpath "$0")")
parent_folder=$(basename "$script_dir")
tool_name=$parent_folder

# The current directory and the repository root are saved in variables
repo_root=$(git rev-parse --show-toplevel)

# Get the path to this tool from the repository root
tool_dir=$(python3 -c "import os.path; print(os.path.relpath('$script_dir', '$repo_root'))")

echo "Building docker image for tool: ${tool_name}"
echo "Tool path from root: ${tool_dir}"

# The version is read from the VERSION file
version=$(<VERSION)

# Determine the platform
ARCH=$(uname -m)

# Set the tag suffix to the architecture if it is not x86_64
ARCH_SUFFIX=-$ARCH
if [ "$ARCH_SUFFIX" == "-x86_64" ]; then
    ARCH_SUFFIX=""
fi

tag="polusai/${tool_name}:${version}"
tag=$tag${ARCH_SUFFIX}

echo "Building docker image with tag: ${tag}"

# The Dockerfile and .dockerignore files are copied to the repository root before building the image
cd ${repo_root}
cp ./${tool_dir}/Dockerfile .
cp .gitignore .dockerignore
docker_command="build . -t ${tag} --build-arg TOOL_DIR=${tool_dir}"
echo "#### $docker_command"
docker $docker_command
rm Dockerfile .dockerignore
cd ${cur_dir}
